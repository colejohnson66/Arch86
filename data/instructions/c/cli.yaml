%YAML 1.2
---
title: Clear Interrupt Flag
opcode:
  - opcode: FA
    mnemonic: CLI
    encoding: ZO
    validity:
      16: valid
      32: valid
      64: valid
    description: >-
      Clear the \reg{IF} flag if the current privilege level allows it.
      The \reg{VIF} flag is cleared as well if in VME or PVI mode.
encoding:
  operands: 1
  encodings:
    ZO:
      - None
description: >-
  If the current privilege level allows it, the \c{CLI} instruction clears the \reg{IF} (interrupt) flag in the \reg{EFLAGS} register.

  The actual operation depends on the current operating mode of the processor.
  See the "Operation" section below.
operation: |-
  public void CLI()
  {
    if (CR0.PE == false)
    {
      // real mode
      IF = 0;
      return;
    }

    if (IOPL > CPL)
    {
      // CPL is 3 in virtual-8086 mode
      IF = 0;
      return;
    }

    bool pvi = VM == false && CPL > 3 && CR4.PVI == true;
    bool vme = VM == true && CR4.VME == true;
    if (pvi || vme)
      VIF = 0;
    else
      #GP(0);
  }
flags:
  CF: Unmodified.
  PF: Unmodified.
  AF: Unmodified.
  ZF: Unmodified.
  SF: Unmodified.
  OF: Unmodified.
exceptions:
  real:
    "#UD": \exception{lock}
  virtual:
    "#UD": \exception{lock}
    "#GP(0)": If \c{CPL} is greater than \c{IOPL} and \c{PVI} mode is not active.
  protected:
    "#UD": \exception{lock}
    "#GP(0)":
      - If \c{CPL} is greater than \c{IOPL} and \c{PVI} mode is not active.
      - If \c{CPL} is greater than \c{IOPL} and less than \c{3}.
  compatibility:
    "#UD": \exception{lock}
    "#GP(0)":
      - If \c{CPL} is greater than \c{IOPL} and \c{PVI} mode is not active.
      - If \c{CPL} is greater than \c{IOPL} and less than \c{3}.
  long:
    "#UD": \exception{lock}
    "#GP(0)":
      - If \c{CPL} is greater than \c{IOPL} and \c{PVI} mode is not active.
      - If \c{CPL} is greater than \c{IOPL} and less than \c{3}.
